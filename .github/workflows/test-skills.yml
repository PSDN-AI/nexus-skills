name: Test Skills

on:
  push:
    branches: [main]
    paths:
      - 'skills/**'
  pull_request:
    paths:
      - 'skills/**'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      skills: ${{ steps.changed.outputs.skills }}
      has_changes: ${{ steps.changed.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed skills
        id: changed
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE="${{ github.event.pull_request.base.sha }}"
          else
            BASE="${{ github.event.before }}"
          fi

          # Find changed skill directories that have a test runner
          SKILLS=()
          for dir in skills/*/; do
            skill=$(basename "$dir")
            if git diff --name-only "$BASE" HEAD -- "$dir" | grep -q .; then
              if [[ -f "$dir/tests/run_tests.sh" ]]; then
                SKILLS+=("\"$skill\"")
              fi
            fi
          done

          if [[ ${#SKILLS[@]} -gt 0 ]]; then
            MATRIX=$(IFS=,; echo "[${SKILLS[*]}]")
            echo "skills=$MATRIX" >> "$GITHUB_OUTPUT"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "Changed skills with tests: $MATRIX"
          else
            echo "skills=[]" >> "$GITHUB_OUTPUT"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No skill changes detected (or no test runners found)"
          fi

  test:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix:
        skill: ${{ fromJSON(needs.detect-changes.outputs.skills) }}
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    name: test / ${{ matrix.skill }} / ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Verify bash version
        run: |
          echo "Bash version: $BASH_VERSION"
          if [[ "${BASH_VERSINFO[0]}" -lt 4 ]]; then
            echo "::error::Bash 4+ required"
            exit 1
          fi

      - name: Run tests
        run: bash "skills/${{ matrix.skill }}/tests/run_tests.sh"

      - name: Shellcheck
        if: runner.os == 'Linux'
        run: |
          sudo apt-get install -y shellcheck
          SKILL_DIR="skills/${{ matrix.skill }}"
          # Lint all .sh files in the skill directory
          find "$SKILL_DIR" -name '*.sh' -not -path '*/tests/*' -exec shellcheck {} +
          # Lint test scripts (allow info-level SC1091 for dynamic source)
          find "$SKILL_DIR/tests" -name '*.sh' -exec shellcheck -S warning {} +
